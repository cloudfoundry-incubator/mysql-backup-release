<%=
  require 'yaml'

  username = p('cf-mysql-backup.endpoint_credentials.username')
  password = p('cf-mysql-backup.endpoint_credentials.password')

  defaults_file=p('cf_mysql.mysql.defaults_file_path')
  if_link('mysql-backup-user-creds') do
    defaults_file="/var/vcap/jobs/streaming-mysql-backup-tool/config/mysql-defaults-file.cnf"
  end

  YAML.dump({
    "PidFile" => "/var/vcap/sys/run/streaming-mysql-backup-tool/streaming-mysql-backup-tool.pid",
    "Command" => "xtrabackup --defaults-file=#{defaults_file} --backup --stream=tar --target-dir=/var/vcap/store/xtrabackup_tmp/",
    "Port" => p('cf-mysql-backup.backup-server.port'),
    "Credentials" => {
      "Username" => username,
      "Password" => password
    },
    "Certificates" => {
      "Cert" => "/var/vcap/jobs/streaming-mysql-backup-tool/certificates/server-cert.pem",
      "Key" => "/var/vcap/jobs/streaming-mysql-backup-tool/certificates/server-key.pem",
      "ClientCA" => "/var/vcap/jobs/streaming-mysql-backup-tool/certificates/client-ca.pem"
    },
    "EnableMutualTLS" => p('cf-mysql-backup.enable_mutual_tls')
  })
%>
